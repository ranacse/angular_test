name: Angular CI/CD to EC2 (Build on Server)

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Deploy and Build on EC2 Server
        uses: appleboy/ssh-action@master
        with:
          # Host IP/DNS
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          # Private Key (using your customized name)
          key: ${{ secrets.EC2_ANGULAR_SSH_PRIVATE_KEY }}
          # Increase timeout for the slow npm build process on EC2
          command_timeout: 20m 
          
          script: |
            echo "--- STARTING BUILD & DEPLOY SCRIPT ON EC2 ---"
            
            # 1. Stop NGINX (Fixes port 80 conflict)
            sudo systemctl stop nginx || true
            sudo systemctl disable nginx || true
            
            # 2. Navigate to the repository directory
            cd /var/angular/
            
            # 3. FIX: Add safe directory for the root user to resolve ownership errors
            # This is critical for subsequent git commands to work
            sudo git config --global --add safe.directory /var/angular
            
            # 4. AUTHENTICATED PULL (The definitive fix for authentication)
            echo "Attempting authenticated git pull with PAT token..."
            
            # Fetch using the PAT token URL (Most reliable private repo access)
            sudo git fetch https://${{ secrets.PAT_TOKEN }}@github.com/ranacse/angular_test.git main 
            
            # Force local repo to match the fetched remote, discarding conflicts
            sudo git reset --hard FETCH_HEAD
            
            # 5. Install dependencies and build the code on the EC2
            sudo npm install 
            # This creates the /var/angular/dist/angular_test folder
            sudo npm run build -- --output-path=./dist/angular_test --base-href=/

            # 6. Correct Permissions and Ownership (Fixes Forbidden error)
            sudo chown -R www-data:www-data /var/angular/
            sudo chmod -R 755 /var/angular/
            
            # 7. Restart Apache 
            sudo systemctl restart apache2
            
            echo "--- DEPLOYMENT SCRIPT FINISHED ---"
