name: Angular CI/CD to EC2 (Build on Server)

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Deploy and Build on EC2 Server
        uses: appleboy/ssh-action@master
        with:
          # This secret must be created: EC2_HOST (Value: your EC2 IP)
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          # FIX: Using the correct secret name you created
          key: ${{ secrets.EC2_ANGULAR_SSH_PRIVATE_KEY }}
          # Increase timeout for the slow npm build process on EC2
          command_timeout: 20m 
          
          script: |
            echo "--- STARTING BUILD & DEPLOY SCRIPT ON EC2 ---"
            
            # 1. Navigate to the repository directory
            cd /var/angular/
            
            # 2. Pull the LATEST SOURCE CODE (The Git action you wanted)
            # This requires the PAT_TOKEN secret and HTTPS URL for private repos
            sudo git pull origin main 
            
            # 3. Install dependencies and build the code on the EC2
            # NOTE: This step is slow and resource-heavy
            sudo npm install 
            # IMPORTANT: Check your angular.json for the exact output path name
            sudo npm run build -- --output-path=./dist/app-name --base-href=/

            # 4. Ensure the web server owns the final built files
            sudo chown -R www-data:www-data /var/angular/
            sudo systemctl restart apache2
            
            echo "--- DEPLOYMENT SCRIPT FINISHED ---"
