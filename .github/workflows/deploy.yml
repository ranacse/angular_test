name: Angular CI/CD to EC2 (Build on Server)

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Deploy and Build on EC2 Server
        uses: appleboy/ssh-action@master
        with:
          # Host IP/DNS
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          # Private Key (using your customized name)
          key: ${{ secrets.EC2_ANGULAR_SSH_PRIVATE_KEY }}
          # Increase timeout for the slow npm build process on EC2
          command_timeout: 20m 
          
          script: |
            echo "--- STARTING BUILD & DEPLOY SCRIPT ON EC2 ---"
            
            # 1. Stop NGINX (Fixes port 80 conflict)
            sudo systemctl stop nginx || true
            sudo systemctl disable nginx || true
            
            # 2. Navigate to the repository directory
            cd /var/angular/
            
            # 3. FORCE PULL (The definitive fix for missing files)
            echo "Attempting simple git pull and hard reset..."
            
            # Fetch remote changes
            sudo git fetch origin 
            # Force local repo to match remote, discarding any local changes/conflicts
            sudo git reset --hard origin/main
            
            # 4. Install dependencies and build the code on the EC2
            sudo npm install 
            # This creates the /var/angular/dist/angular_test folder
            sudo npm run build -- --output-path=./dist/angular_test --base-href=/

            # 5. Correct Permissions and Ownership
            sudo chown -R www-data:www-data /var/angular/
            sudo chmod -R 755 /var/angular/
            
            # 6. Restart Apache 
            sudo systemctl restart apache2
            
            echo "--- DEPLOYMENT SCRIPT FINISHED ---"
